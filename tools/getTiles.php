<?

$polygon = 'POLYGON((12.98566 54.01057, 12.99285 54.02046, 13.01974 54.01891, 13.03771 54.02956, 13.07879 54.03637, 13.08262 54.04058, 13.09862 54.04396, 13.11425 54.04233, 13.11764 54.03341, 13.13503 54.03151, 13.13977 54.02661, 13.14735 54.02637, 13.15221 54.03218, 13.19382 54.0418, 13.20287 54.03988, 13.20627 54.04704, 13.24516 54.07182, 13.27415 54.06819, 13.27827 54.07151, 13.25082 54.08198, 13.24142 54.09747, 13.21758 54.10318, 13.20921 54.11915, 13.21681 54.12442, 13.23871 54.12637, 13.24882 54.1329, 13.2827 54.13754, 13.28133 54.16667, 13.29186 54.18093, 13.31621 54.19768, 13.32477 54.19676, 13.33202 54.18728, 13.34648 54.18605, 13.3669 54.1896, 13.37909 54.18159, 13.38569 54.18061, 13.39228 54.18548, 13.40218 54.18483, 13.42455 54.17611, 13.43024 54.16754, 13.42149 54.16148, 13.41725 54.14963, 13.43976 54.13422, 13.44776 54.12345, 13.44708 54.11305, 13.46375 54.10019, 13.46384 54.09367, 13.49283 54.08807, 13.48 54.09869, 13.46872 54.11684, 13.47117 54.12176, 13.49007 54.12948, 13.52847 54.13545, 13.58149 54.13719, 13.62154 54.14405, 13.65406 54.15957, 13.69651 54.1769, 13.71083 54.17526, 13.72576 54.1646, 13.72327 54.15973, 13.70474 54.15269, 13.73712 54.14131, 13.74673 54.14412, 13.74163 54.15894, 13.75277 54.17169, 13.79745 54.17881, 13.80961 54.18367, 13.81657 54.18301, 13.83589 54.13891, 13.85117 54.12324, 13.87751 54.10476, 13.9125 54.08847, 13.93296 54.08107, 13.97225 54.07361, 14.02021 54.0569, 14.08469 54.01523, 14.15213 53.97993, 14.1551 53.974, 14.18138 53.95542, 14.19148 53.94952, 14.20193 53.94364, 14.23355 53.92981, 14.2325 53.9253, 14.21259 53.91248, 14.21218 53.90785, 14.21977 53.90118, 14.22296 53.88101, 14.22134 53.86446, 14.21642 53.86112, 14.20384 53.86174, 14.1891 53.86819, 14.11373 53.86465, 14.08595 53.86964, 14.06191 53.86488, 14.04018 53.86963, 14.02388 53.86464, 13.99302 53.84409, 13.98109 53.84563, 13.93974 53.83882, 13.92212 53.84155, 13.90023 53.83558, 13.87646 53.83587, 13.88212 53.82445, 13.92263 53.809, 13.96537 53.78366, 14.11851 53.74413, 14.18391 53.74459, 14.22555 53.76663, 14.27539 53.75332, 14.28152 53.74379, 14.27611 53.70987, 14.27455 53.69973, 14.29121 53.68341, 14.2895 53.67308, 14.283 53.66688, 14.29205 53.66011, 14.29133 53.63627, 14.3245 53.61856, 14.32144 53.56495, 14.31188 53.55491, 14.31376 53.54533, 14.32376 53.537, 14.32688 53.52993, 14.3237 53.5247, 14.33362 53.50638, 14.35792 53.49724, 14.36425 53.46128, 14.37444 53.46051, 14.37868 53.4573, 14.37629 53.43233, 14.3809 53.40962, 14.402 53.37712, 14.39932 53.35553, 14.41271 53.34841, 14.41839 53.32703, 14.39681 53.32423, 14.37999 53.31208, 14.35659 53.30993, 14.35135 53.3057, 14.32337 53.30717, 14.30769 53.2833, 14.27086 53.27401, 14.27342 53.25892, 14.26676 53.25486, 14.21061 53.25033, 14.19715 53.25612, 14.17322 53.25789, 14.16016 53.26303, 14.12294 53.25565, 14.09435 53.25804, 14.0916 53.26174, 14.0959 53.27451, 14.10393 53.28542, 14.19846 53.34412, 14.22036 53.36481, 14.23592 53.39299, 14.22991 53.41404, 14.23196 53.42367, 14.2235 53.42802, 14.2082 53.41873, 14.17663 53.41825, 14.13712 53.43484, 14.1249 53.43596, 14.11145 53.41973, 14.09628 53.41717, 14.08322 53.40639, 14.0698 53.4104, 14.05126 53.40854, 14.04359 53.41237, 14.03918 53.425, 14.00613 53.42598, 13.9984 53.42975, 13.94669 53.42589, 13.92146 53.41762, 13.91406 53.41777, 13.90109 53.42389, 13.89542 53.43177, 13.90302 53.43777, 13.89815 53.44626, 13.91005 53.45006, 13.90899 53.45394, 13.86834 53.47194, 13.87421 53.48219, 13.86595 53.48966, 13.86976 53.50239, 13.84614 53.51062, 13.8166 53.51473, 13.79094 53.54936, 13.78408 53.53119, 13.78664 53.51752, 13.79828 53.51391, 13.80387 53.50564, 13.82385 53.50436, 13.8341 53.49925, 13.81765 53.48099, 13.80519 53.474, 13.78153 53.46968, 13.75161 53.47369, 13.74134 53.47827, 13.71775 53.47758, 13.71035 53.47448, 13.70105 53.4764, 13.68032 53.48993, 13.68746 53.5043, 13.66696 53.50525, 13.6615 53.51168, 13.66521 53.51917, 13.67462 53.52425, 13.67038 53.53154, 13.67275 53.53838, 13.70355 53.54149, 13.71642 53.54653, 13.71108 53.56131, 13.71653 53.56979, 13.70266 53.57381, 13.70146 53.58288, 13.69285 53.58958, 13.69279 53.594, 13.75134 53.61907, 13.74394 53.62158, 13.72589 53.62137, 13.72222 53.62616, 13.72774 53.6337, 13.70086 53.64215, 13.68678 53.65191, 13.71914 53.67208, 13.74697 53.67617, 13.75605 53.68115, 13.71769 53.69313, 13.65832 53.69323, 13.63837 53.69935, 13.55032 53.69073, 13.52905 53.70007, 13.51565 53.71464, 13.51773 53.72404, 13.49814 53.73968, 13.43939 53.74406, 13.39575 53.75691, 13.37523 53.74404, 13.36271 53.74618, 13.35307 53.75821, 13.3651 53.76678, 13.34618 53.78201, 13.33717 53.785, 13.33658 53.80476, 13.34094 53.80797, 13.35283 53.80855, 13.37395 53.80421, 13.3852 53.81662, 13.38804 53.83137, 13.3732 53.8407, 13.36275 53.83894, 13.34423 53.84292, 13.33914 53.8314, 13.32058 53.82755, 13.31066 53.82073, 13.3038 53.80699, 13.27937 53.80621, 13.26703 53.81301, 13.23778 53.80343, 13.22841 53.80457, 13.20315 53.82202, 13.18675 53.82729, 13.17861 53.83508, 13.18196 53.84835, 13.17399 53.85678, 13.17559 53.86357, 13.18451 53.86815, 13.18989 53.8858, 13.18424 53.88918, 13.1848 53.8954, 13.19231 53.90426, 13.20414 53.90801, 13.19329 53.92364, 13.1566 53.93838, 13.13685 53.92784, 13.12959 53.9277, 13.10271 53.94314, 13.08712 53.94159, 13.05933 53.95122, 13.04825 53.96712, 13.02542 53.97566, 12.99754 53.97235, 12.98918 53.98725, 13.00383 53.99152, 12.98007 54.00172, 12.98566 54.01057))';
$url = 'https://www.orka-mv.de/geodienste/orkamv/tiles/1.0.0/orkamv/GLOBAL_WEBMERCATOR/{z}/{x}/{y}.png';
$folder = '/var/www/data/tiles/';

error_reporting(E_ALL & ~(E_STRICT|E_NOTICE));

include('../config.php');
include(CLASSPATH.'log.php');
include(CLASSPATH.'postgresql.php');
$debug=new Debugger(DEBUGFILE);
$database = new pgdatabase();
$database->open(POSTGRES_CONNECTION_ID);

function deg2num($lat_deg, $lon_deg, $zoom){
	$lat_rad = deg2rad($lat_deg);
	$n = pow(2.0, $zoom);
	$xtile = floor(($lon_deg + 180.0) / 360.0 * $n);
	$ytile = floor((1.0 - log(tan($lat_rad) + (1 / cos($lat_rad))) / pi()) / 2.0 * $n);
	return [$xtile, $ytile];
}
	
function num2deg($xtile, $ytile, $zoom){
	$n = pow(2.0, $zoom);
	$lon_deg = $xtile / $n * 360.0 - 180.0;
	$lat_rad = atan(sinh(pi() * (1 - 2 * $ytile / $n)));
	$lat_deg = rad2deg($lat_rad);
	return [$lat_deg, $lon_deg];
}


/**
 * get the numbers of the tiles that intersect with the polygon	
*/
 function getTileNumbers($polygon, $zoom){
	global $database;
	# BBox des Polygons bestimmen
	$sql = "
		SELECT 
			st_xmin(geom) minx, 
			st_xmax(geom) maxx,
			st_ymin(geom) miny,
			st_ymax(geom) maxy
		FROM (
			SELECT st_geomfromtext('".$polygon."') as geom
		) as foo
		";
	$ret = pg_query($database->dbConn, $sql);
	$rs=pg_fetch_assoc($ret);
	$minx=$rs['minx'];
	$miny=$rs['miny'];
	$maxx=$rs['maxx'];
	$maxy=$rs['maxy'];
	
	# Kachelnummern aus BBox bestimmen
	$upper_left = deg2num($maxy, $minx, $zoom);		// links oben
	$lower_right = deg2num($miny, $maxx, $zoom);	// rechts unten
	$lower_right[0]++;
	$lower_right[1]++;
	$x_count = $lower_right[0] - $upper_left[0];	// Kachelanzahl in x-Richting
	$y_count = $lower_right[1] - $upper_left[1];	// Kachelanzahl in y-Richting

	# BBox der Kacheln bestimmen
	$upper_left_tiles = num2deg($upper_left[0], $upper_left[1], $zoom);
	$lower_right_tiles = num2deg($lower_right[0], $lower_right[1], $zoom);
		
	# Kachel-BBox nach 900913 transformieren
	$sql = "
		SELECT 
			st_x(min) AS minx, 
			st_y(min) AS miny,
			st_x(max) AS maxx, 
			st_y(max) AS maxy
    FROM (
			SELECT
				st_transform(st_geomfromtext('POINT(".$upper_left_tiles[1]." ".$lower_right_tiles[0].")', 4326), 900913) AS min,
				st_transform(st_geomfromtext('POINT(".$lower_right_tiles[1]." ".$upper_left_tiles[0].")', 4326), 900913) AS max
    ) AS foo
	";
	$ret = pg_query($database->dbConn, $sql);
	$rs=pg_fetch_assoc($ret);
	$minx=$rs['minx'];
	$miny=$rs['miny'];
	$maxx=$rs['maxx'];
	$maxy=$rs['maxy'];
	$tile_width = ($maxy - $miny) / $y_count;		// Kachelbreite in 900913
	
	# Grid-Tabelle erzeugen
	echo 'Erzeuge Grid-Tabelle ... ';
	$sql = "
		CREATE TABLE tile_grid_table as
			SELECT 
				round((st_xmin(geom) - ".$minx.")/".$tile_width.") + ".$upper_left[0]." as x,
				round((".$maxy." - st_ymax(geom))/".$tile_width.") + ".$upper_left[1]." as y,
				geom 
			FROM (
				SELECT ST_SetSRID((ST_PixelAsPolygons(ST_AddBand(ST_MakeEmptyRaster(
					".$x_count.", 
					".$y_count.", 
					".$minx.", 
					".$maxy.", 
					".$tile_width."
				), '8BSI'::text, 1, 0), 1, false)).geom, 900913) as geom
			) as foo;
			
		CREATE INDEX tile_grid_table_gist
		ON tile_grid_table
		USING gist
		(geom);
	";
	#echo $sql;
	$ret = pg_query($database->dbConn, $sql);
	
	# Kachelnummern durch Verschneidung des Polygons mit Grid-Tabelle bestimmen
	$sql = "
		SELECT 
			x, y, st_intersects(geom, st_transform(st_geomfromtext('".$polygon."', 4326), 900913)) as intersects
		FROM
			tile_grid_table
	";
	$ret = pg_query($database->dbConn, $sql);
	while($rs=pg_fetch_assoc($ret)){
		$tiles[] = $rs;
	}
	
	# Grid-Tabelle wieder löschen
	$sql = "
		DROP TABLE tile_grid_table;
	";
	$ret = pg_query($database->dbConn, $sql);
	
	return $tiles;
}


function downloadTiles($tiles, $zoom){
	global $tile_count;
	global $url;
	global $folder;
	$count = 0;
	$ch =  curl_init();
	foreach($tiles as $tile){
		$dirname = $folder.$zoom.'/'.$tile['x'].'/';
		if(!is_dir($dirname)){
			mkdir($dirname, 0755, true);
		}		
		if($tile['intersects'] == 't'){			# Kacheln, die das Polygon schneiden downloaden
			$out = fopen($dirname.$tile['y'].'.png',"wb");
			$request_url = str_replace(['{x}', '{y}', '{z}'], [$tile['x'], $tile['y'], $zoom], $url);
			curl_setopt($ch, CURLOPT_URL, $request_url);		// !! das bringt einen Performance-Boost, anstatt jedesmal ein curl_init mit der URL zu machen !!
			curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
			curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
			curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
			curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15);
			curl_setopt($ch, CURLOPT_TIMEOUT, 10);
			curl_setopt($ch, CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
			curl_setopt($ch, CURLOPT_FILE, $out);
			if($result = curl_exec($ch) === false){
				echo curl_error($ch);
				prev($tiles);
			}
			else{
				$count++;
				echo $count.'/'.$tile_count." fertig\n";
			}
		}
		else{		# für alle anderen Dummy-Kachel speichern
			copy('../graphics/dummy_tile.png', $dirname.$tile['y'].'.png');
			$count++;
			echo $count.'/'.$tile_count." fertig\n";
		}
	}
 }

/*
function downloadTiles($tiles, $zoom){
	global $tile_count;
	global $url;
	global $folder;
	$count = 0;
	$mh = curl_multi_init();
	for($i = 0; $i < count($tiles); $i++){
		$dirname = $folder.$zoom.'/'.$tiles[$i]['y'].'/';
		if(!is_dir($dirname)){
			mkdir($dirname, 0755, true);
		}		
		$out = fopen($dirname.$tiles[$i]['x'].'.png',"wb");
		$request_url = str_replace(['{x}', '{y}', '{z}'], [$tiles[$i]['x'], $tiles[$i]['y'], $zoom], $url);
		$ch[$i] =  curl_init($request_url);
    curl_setopt($ch[$i], CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch[$i], CURLOPT_SSL_VERIFYPEER, 0);
    curl_setopt($ch[$i], CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
    curl_setopt($ch[$i], CURLOPT_CONNECTTIMEOUT, 5);
    curl_setopt($ch[$i], CURLOPT_TIMEOUT, 3);
		curl_setopt($ch[$i], CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
		curl_setopt($ch[$i], CURLOPT_FILE, $out);
		curl_multi_add_handle($mh,$ch[$i]);
	}
	do {
    $status = curl_multi_exec($mh, $active);
		$count++;
		echo 'finished '.$count.'/'.$tile_count."\n";		
    if ($active) {
        curl_multi_select($mh);
    }
	} while ($active && $status == CURLM_OK);
}
*/

if($argv[1] == ''){
	echo "Fehler! Kein Zoomlevel angegeben. Benutzung: php getTiles.php <zoom_von> <zoom_bis>\n";
}
else{
	if($argv[2] == ''){
		$argv[2] = $argv[1];
	}
	for($zoom = $argv[1]; $zoom <= $argv[2]; $zoom++){
		$tiles = getTileNumbers($polygon, $zoom);
		$tile_count = count($tiles);
		echo 'Anzahl Kacheln für Zoom-Level '.$zoom.': '.$tile_count."\n";
		downloadTiles($tiles, $zoom);
	}
}

?>
